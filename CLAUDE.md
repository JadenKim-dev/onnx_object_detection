# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A Next.js application for object detection using YOLOv11 models exported to ONNX format. The project has two distinct environments:
1. **Python environment**: For exporting YOLO models to ONNX format (scripts)
2. **Next.js environment**: For web-based inference using onnxruntime-web

## Development Commands

### Next.js (Frontend)
```bash
npm run dev          # Development server on http://localhost:3000
npm run build        # Production build
npm run start        # Start production server
npm run lint         # Run ESLint
```

### Python (Model Export)
```bash
# Setup (first time only)
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt

# Export models
python scripts/export_models.py

# Run tests
pytest                    # All tests
pytest -v                 # Verbose output
pytest -m "not slow"      # Skip performance benchmarks
pytest -k "yolo11n"       # Test specific model
```

## Architecture

### Model Export Pipeline
The `scripts/export_models.py` script:
- Downloads YOLOv11 models (n/s/m variants) from Ultralytics
- Exports to ONNX with browser-optimized config (opset=12, FP32, fixed shapes)
- Generates metadata files:
  - `public/data/coco_classes.json` - Static COCO 80 class definitions (committed)
  - `public/data/models.json` - Model metadata with timestamps (ignored in git)
  - `public/models/*.onnx` - Model binaries (ignored in git, 10-77MB each)

**Key export configuration:**
- `opset: 12` - Compatible with onnxruntime-web 1.23.2
- `dynamic: false` - Fixed input shape [1,3,640,640] for performance
- `nms: false` - Non-Maximum Suppression handled in JavaScript
- `half: false` - FP32 precision for browser compatibility

### Model I/O Format
- **Input**: `[1, 3, 640, 640]` (batch, channels, height, width) - RGB image
- **Output**: `[1, 84, 8400]` (batch, features, predictions)
  - 84 features = 4 bbox coords (cx, cy, w, h) + 80 class scores
  - 8400 predictions = anchor points across feature pyramid

### Testing Structure
Tests validate exported ONNX models using pytest with parametrized fixtures:
- `tests/conftest.py` - Shared fixtures (model paths, sessions, configs)
- `tests/test_models.py` - Model validation (21 tests across 3 models)

Test markers:
- `slow` - Performance benchmarks
- `inference` - Model inference tests
- `integration` - End-to-end pipeline tests

## Git Operations

**IMPORTANT**: Do NOT stage files using `git add` command unless explicitly requested by the user.

## File Generation

The following files are generated by `scripts/export_models.py` and ignored in git:
- `public/models/*.onnx` - Large model binaries (regenerate locally)
- `public/data/models.json` - Contains timestamps, regenerate with each export

The following is committed:
- `public/data/coco_classes.json` - Static class definitions (never changes)
